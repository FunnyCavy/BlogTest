# Redis 数据持久化

## 「单节点 Redis 存在的问题」

- **数据丢失:** Redis 使用内存存储, 服务重启可能造成数据丢失的问题
- **并发能力:** Redis 在单节点状态下无法满足高并发的场景
- **故障恢复:** Redis 宕机后会造成服务不可用, 不具备自动的故障恢复手段
- **存储能力:** Redis 基于内存, 单节点能存储的数据量有限

## 「RDB & AOF 持久化」

### 『RDB 持久化』

#### 概念

RBD *(Redis Database Backup File)*, 也叫 Redis 数据快照

通过 RDB 备份得到的快照文件也称为 **RDB 文件**

- 导出 RDB 文件时, 会将当前 Redis 数据库中的所有键值对保存到指定的文件中
- 导入 RDB 文件时, Redis 会将文件中包含的键值对全部加载到内存中

#### 使用

使用 `SAVE` 或 `BGSAVE` 可以在 Redis 中导出 RDB 文件到主进程所运行的目录中

- `SAVE` 命令会阻塞 Redis 服务器, 直到数据集被完全写入磁盘为止
- `BGSAVE` 命令会在后台开启子进程执行快照操作, 不会阻塞服务器

> RDB 默认触发时机
> - **Redis 停机时:** 如果开启了 RDB, 会自动执行一次 `SAVE` 命令
> - **Redis 启动时:** 会检测 RDB 文件是否存在, 若存在则自动导入

在 Redis 的配置文件中, 可以更改 RDB 相关配置及触发时机

```
# RDB 文件名称
dbfilename dump.rdb

# RDB 文件保存目录
dir ./

# 是否压缩 RDB 文件
rdbcompression no

# 每 60 秒中, 如果至少有 10 个 Key 被修改, 则触发 BGSAVE (可以设置多个规则)
save 60 10
save 600 50
```

#### 命令 `BGSAVE` 原理

- fork 主进程得到子进程
- 子进程**共享**主进程的内存数据
- 完成 fork 后读取内存数据并写入 RDB 文件
- fork 采用的是 copy-on-write 技术
    - 当主进程执行读操作时, 访问共享内存
    - 当主进程执行写操作时, 则会拷贝一份数据再执行写操作

### 『AOF 持久化』

#### 概念

AOF *(Append Only File)*, 也叫追加模式或日志模式

通过 AOF 备份得到的日志文件也称为 **AOF 文件**

- AOF 文件是一种以文本形式保存的 Redis 操作日志文件
- AOF 文件包含了 Redis 服务器执行的所有写操作, 包括对键进行的增删改等操作
- AOF 文件支持压缩和重写, 以减少文件大小和提高性能

#### 使用

> AOF 默认为关闭状态, 需要修改 Redis 配置文件来开启 AOF

在 Redis 的配置文件中, 可以更改 AOF 相关配置及重写策略

```
# 是否开启 AOF
appendonly yes

# AOF 文件名称
appendfilename "appendonly.aof"

# AOF 文件刷盘策略
appendfsync everysec

# AOF 文件触发自动重写的体积增长百分比要求
auto-aof-rewrite-percentage 100

# AOF 文件触发自动重写的最小体积要求
auto-aof-rewrite-min-size 64mb
```

| AOF 文件刷盘策略 | 刷盘时机 |  优点  |    缺点    |
|:----------:|:----:|:----:|:--------:|
|  `always`  | 同步刷盘 | 可靠性高 |   性能较差   |
| `everysec` | 每秒刷盘 | 性能适中 | 最多丢失一秒数据 |
|    `no`    | 系统决定 | 性能最好 |  可靠性较差   |

> AOF 文件重写
> - AOF 文件会记录对同一个 Key 的多次操作, 因此会产生大量冗余命令
> - 使用  `BGREWRITEOF` 命令可以对 AOF 文件执行重写操作
> - 重写后的 AOF 文件可使用最少的命令达到与原文件相同的效果

### 『对比 RDB 与 AOF』

| 比较      | RDB                    | AOF                             |
|---------|------------------------|---------------------------------|
| 持久化策略   | 定时对整个内存做快照             | 记录每一次执行的命令                      |
| 数据完整性   | 不完整，两次备份之间会丢失          | 相对完整，取决于刷盘策略                    |
| 文件大小    | 会有压缩，文件体积小             | 记录命令，文件体积很大                     |
| 数据恢复速度  | 很快                     | 慢                               |
| 数据恢复优先级 | 低，因为数据完整性不如AOF         | 高，因为数据完整性更高                     |
| 系统资源占用  | 高，大量CPU和内存消耗           | 低，主要是磁盘IO资源但AOF重写时会占用大量CPU和内存资源 |
| 使用场景    | 可以容忍数分钟的数据丢失，追求更快的启动速度 | 对数据安全性要求较高常见                    |
